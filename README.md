# S3 Proxy

Unified S3-compatible endpoint that routes objects to one or more storage backends with per-backend quota management. Metadata and quota tracking live in PostgreSQL; the backends only see standard S3 API calls.

## Architecture

```
S3 clients (aws cli, rclone, etc.)
        |
        v
  +-----------+
  | S3 Proxy  |  <-- SigV4 auth, virtual bucket routing
  +-----------+
        |
   +----+----+
   v         v
PostgreSQL   OCI Object Storage (or any S3-compatible backend)
(metadata)   (actual objects)
```

- **PostgreSQL** stores object locations (`object_locations`), per-backend quota counters (`backend_quotas`), and multipart upload state (`multipart_uploads`, `multipart_parts`). Schema is applied automatically on startup via embedded SQL. All queries are generated by [sqlc](https://sqlc.dev/) from annotated SQL files and executed via [pgx/v5](https://github.com/jackc/pgx) connection pools.
- **Backends** are standard S3-compatible services accessed via AWS SDK v2. Currently configured with OCI Object Storage on the Always Free tier (20 GB).
- **Quota routing** selects the first backend with available space when writing objects. Quota is updated atomically in a transaction alongside the object location record.

## S3 API Coverage

| Operation | Method | Path | Supported |
|-----------|--------|------|-----------|
| PutObject | `PUT` | `/{bucket}/{key}` | Yes |
| GetObject | `GET` | `/{bucket}/{key}` | Yes |
| HeadObject | `HEAD` | `/{bucket}/{key}` | Yes |
| DeleteObject | `DELETE` | `/{bucket}/{key}` | Yes |
| ListObjectsV2 | `GET` | `/{bucket}?list-type=2` | Yes |
| CreateMultipartUpload | `POST` | `/{bucket}/{key}?uploads` | Yes |
| UploadPart | `PUT` | `/{bucket}/{key}?partNumber=N&uploadId=X` | Yes |
| CompleteMultipartUpload | `POST` | `/{bucket}/{key}?uploadId=X` | Yes |
| AbortMultipartUpload | `DELETE` | `/{bucket}/{key}?uploadId=X` | Yes |
| ListParts | `GET` | `/{bucket}/{key}?uploadId=X` | Yes |

All requests must target the configured virtual bucket name (default: `unified`). Requests to other bucket names return `404 NoSuchBucket`.

## Authentication

Two methods, checked in order:

1. **AWS SigV4** (recommended) - Standard AWS Signature Version 4 via the `Authorization` header. Compatible with `aws cli`, SDKs, and any S3 client.
2. **Legacy token** - Simple `X-Proxy-Token` header for backward compatibility.

If neither `access_key_id` nor `token` is configured, authentication is disabled.

## Configuration

YAML config file specified via `-config` flag (default: `config.yaml`). Supports `${ENV_VAR}` expansion.

```yaml
server:
  listen_addr: "0.0.0.0:9000"
  virtual_bucket: "unified"

auth:
  access_key_id: "YOUR_ACCESS_KEY"
  secret_access_key: "YOUR_SECRET_KEY"
  token: "optional-legacy-token"

database:
  host: "localhost"
  port: 5432
  database: "s3proxy"
  user: "s3proxy"
  password: "secret"
  ssl_mode: "require"    # require for production

backends:
  - name: "oci"
    endpoint: "https://namespace.compat.objectstorage.region.oraclecloud.com"
    region: "us-phoenix-1"
    bucket: "my-bucket"
    access_key_id: "backend-access-key"
    secret_access_key: "backend-secret-key"
    force_path_style: true    # required for OCI, MinIO, B2
    quota_bytes: 21474836480  # 20 GB

telemetry:
  metrics:
    enabled: true
    path: "/metrics"
  tracing:
    enabled: true
    endpoint: "tempo.service.consul:4317"
    insecure: true
    sample_rate: 1.0
```

## Database

The proxy connects to PostgreSQL via pgx/v5 connection pools and auto-applies its schema on startup (all DDL uses `IF NOT EXISTS`). Four tables are created:

| Table | Purpose |
|-------|---------|
| `backend_quotas` | Per-backend byte limits and usage counters |
| `object_locations` | Maps object keys to backends with size tracking |
| `multipart_uploads` | In-progress multipart upload metadata |
| `multipart_parts` | Individual parts for active multipart uploads |

Quota updates are transactional: object location inserts/deletes and quota counter changes happen atomically.

All SQL queries live in `internal/storage/sqlc/queries/` as annotated `.sql` files. Type-safe Go code is generated by sqlc into `internal/storage/sqlc/`. To regenerate after editing queries:

```bash
make generate
```

## Telemetry

### Prometheus Metrics

All metrics are prefixed with `s3proxy_`. Exposed at `/metrics` when enabled.

| Metric | Type | Labels | Description |
|--------|------|--------|-------------|
| `s3proxy_build_info` | Gauge | version, go_version | Build metadata |
| `s3proxy_requests_total` | Counter | method, status_code | HTTP request count |
| `s3proxy_request_duration_seconds` | Histogram | method | Request latency |
| `s3proxy_request_size_bytes` | Histogram | method | Upload sizes |
| `s3proxy_response_size_bytes` | Histogram | method | Download sizes |
| `s3proxy_inflight_requests` | Gauge | method | Currently processing |
| `s3proxy_backend_requests_total` | Counter | operation, backend, status | Backend S3 API calls |
| `s3proxy_backend_duration_seconds` | Histogram | operation, backend | Backend latency |
| `s3proxy_manager_requests_total` | Counter | operation, backend, status | Manager-level operations |
| `s3proxy_manager_duration_seconds` | Histogram | operation, backend | Manager latency |
| `s3proxy_quota_bytes_used` | Gauge | backend | Current bytes used |
| `s3proxy_quota_bytes_limit` | Gauge | backend | Quota limit |
| `s3proxy_quota_bytes_available` | Gauge | backend | Remaining space |
| `s3proxy_objects_count` | Gauge | backend | Stored object count |
| `s3proxy_active_multipart_uploads` | Gauge | backend | In-progress uploads |

Quota metrics are refreshed from PostgreSQL every 30 seconds (no backend API calls).

### OpenTelemetry Tracing

Spans are emitted for every HTTP request, manager operation, and backend S3 call. Traces propagate via W3C `traceparent` headers. Configured to export via gRPC OTLP to Tempo.

## Endpoints

| Path | Purpose |
|------|---------|
| `/health` | Health check (returns `ok`) |
| `/metrics` | Prometheus metrics |
| `/{bucket}/{key}` | S3 API |

## Background Tasks

- **Quota metrics updater** - every 30 seconds, queries PostgreSQL for quota stats, object counts, and multipart upload counts. Updates Prometheus gauges.
- **Stale multipart cleanup** - every hour, aborts multipart uploads older than 24 hours and deletes their temporary part objects from the backend.

## Sync Subcommand

Imports pre-existing objects from a backend S3 bucket into the proxy's metadata database. Useful when bringing an existing bucket under proxy management.

```bash
# Import all objects from a backend
s3-proxy sync --config config.yaml --backend oci

# Preview what would be imported
s3-proxy sync --config config.yaml --backend oci --dry-run

# Import only objects under a prefix
s3-proxy sync --config config.yaml --backend oci --prefix photos/
```

| Flag | Default | Description |
|------|---------|-------------|
| `--config` | `config.yaml` | Path to configuration file |
| `--backend` | (required) | Backend name to sync |
| `--prefix` | `""` | Only sync objects with this key prefix |
| `--dry-run` | `false` | Preview what would be imported without writing |

Objects already tracked in the database for that backend are skipped. The command logs per-page progress and a final summary with imported count, skipped count, and total bytes imported.

## Development

```bash
# Regenerate sqlc query code (after editing .sql files)
make generate

# Run locally (requires PostgreSQL and config.yaml)
make run

# Run unit tests
make test

# Run integration tests (requires Docker)
make integration-test

# Build local Docker image
make build

# Build multi-arch and push to registry
make push
```

## Deployment

Deployed as a Nomad pack job via the `munchbox-service` pack:

```bash
source munchbox-env.sh && cd nomad && make run JOB=s3-proxy
```

### Prerequisites

- PostgreSQL database `s3proxy` on the shared Patroni cluster
- Vault secret at `secret/s3-proxy` with all config values
- Docker image pushed to `registry.munchbox.cc/s3-proxy:latest`
- OCI Object Storage bucket provisioned via Terragrunt (`infrastructure/terragrunt/oci/object-storage/`)

### Monitoring

- Prometheus scrapes via Consul service discovery
- Grafana dashboard: "S3 Proxy" (uid: `munchbox-s3-proxy`)
- Alert rules in `s3-proxy-health` group: service down, error rate, backend failures, quota warnings, latency

## Project Structure

```
src/s3-proxy/
  cmd/s3-proxy/
    main.go                  Entry point, subcommand dispatch, serve logic
    sync.go                  Sync subcommand (bucket import)
  internal/
    auth/auth.go              SigV4 verification, legacy token auth
    config/config.go          YAML config loader with env var expansion
    server/
      server.go               HTTP router, auth middleware, metrics recording
      objects.go               PUT, GET, HEAD, DELETE handlers
      list.go                  ListObjectsV2 handler (XML response)
      multipart.go             Multipart upload handlers
      helpers.go               Path parsing, S3 XML error responses
    storage/
      backend.go               S3 client (AWS SDK v2)
      manager.go               Multi-backend routing with quota selection
      store.go                 PostgreSQL storage layer (pgx/v5 + sqlc)
      migration.sql            Schema DDL (embedded, applied on startup)
      rebalancer.go            Object rebalancing across backends
      replicator.go            Cross-backend object replication
      sqlc/
        schema.sql             Schema for sqlc code generation
        queries/               Annotated SQL query files
          quota.sql            Quota CRUD operations
          objects.sql          Object location operations
          replication.sql      Under-replication detection, conditional inserts
          multipart.sql        Multipart upload lifecycle
        *.go                   Generated type-safe query code (do not edit)
    telemetry/
      metrics.go               Prometheus metric definitions
      tracing.go               OpenTelemetry tracer setup
  sqlc.yaml                    sqlc configuration
  Dockerfile                   Multi-stage build
  Makefile                     Build, test, generate, push targets
  config.example.yaml          Configuration reference
```
